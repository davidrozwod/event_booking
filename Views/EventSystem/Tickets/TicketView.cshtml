@model TicketPriceViewModel
@using Newtonsoft.Json
@using event_booking.Models.ViewModels;

@{
    var discountsJson = JsonConvert.SerializeObject(Model.Discounts);
}

<div class="container">
    <header>
        <h2>@Model.Event.Name</h2>
        <h3>Venue: @Model.Venue.Name</h3>
        <h4>Seat: @Model.Seat.SeatNumber</h4>
    </header>

    <div id="ticketsContainer">
        <div class="ticket">
            <form id="ticketForm" asp-action="ConfirmPurchase" method="post">
                <div id="ticketInputs">
                    <input type="hidden" name="Tickets[0].TicketId" id="TicketId_0" />

                    <label for="FirstName">First Name:</label>
                    <input type="text" id="FirstName" name="FirstName" placeholder="@ViewBag.FirstName" required />

                    <label for="LastName">Last Name:</label>
                    <input type="text" id="LastName" name="LastName" placeholder="@ViewBag.LastName" required />

                    <label for="DiscountId">Discount:</label>
                    <select id="DiscountId" name="Discount" onchange="recalculatePrice()">
                        @foreach (var discount in Model.DiscountNames)
                        {
                            <option value="@discount.Key">@discount.Value</option>
                        }
                    </select>

                    <label for="TicketPrice">Ticket Price:</label>
                    <input type="text" id="TicketPriceDisplay" value="@Model.Ticket.TicketPrice" disabled />
                    <input type="hidden" id="TicketPrice" name="TicketPrice" value="@Model.Ticket.TicketPrice" />
                </div>
                <input type="hidden" id="PurchaseId" value="@Model.Purchase.PurchaseId" />
                <input type="hidden" id="EventId" value="@Model.Event.EventId" />
                <p id="SessionExpiryTime">@Model.Purchase.SessionExpiryTime</p>
                }

                <button type="button" id="addTicketButton">Add another ticket</button>
                <input type="submit" value="Purchase" />
            </form>
        </div>
    </div>

    <form asp-controller="ESTicketsPage" asp-action="CancelPurchase" method="post">
        <input type="hidden" asp-for="Ticket.TicketId" />
        <input type="submit" value="Cancel Purchase" />
    </form>

</div>

@* Javascript for live price update functionality *@
<script type="text/javascript">
    function recalculatePrice() {
        // Get the selected discount
        var selectedDiscountId = $('#DiscountId').val();
        var discounts = @Html.Raw(discountsJson);

        // Get the discount multiplier from the selected discount
        var discountMultiplier = discounts[selectedDiscountId];

        // Get the base price (this should be passed from your server-side code)
        var basePrice = @Model.Ticket.BasePrice;

        // Calculate the new price
        var newPrice = basePrice * discountMultiplier;

        // Update the price in the form
        $('#TicketPriceDisplay').val(newPrice);
        $('#TicketPrice').val(newPrice);
    }

    // Call the function once when the page loads to set the initial price
    $(document).ready(function () {
        recalculatePrice();
    });
</script>

@* Add ticket javascript *@
<script type="text/javascript">
    document.getElementById('addTicketButton').addEventListener('click', () => {
        // The PurchaseId and EventId should be stored in the frontend, either in hidden fields or JavaScript variables
        let purchaseId = document.getElementById('PurchaseId').value;
        let eventId = document.getElementById('EventId').value;

        fetch(`/ESTicketsPage/AddTicket?eventId=${eventId}&purchaseId=${purchaseId}`, {
            method: 'POST',
        })
            .then(response => response.json())
            .then(data => {
                // Here you need to generate the necessary HTML for the new ticket input and append it to the form
                const ticketInputs = document.getElementById('ticketInputs');

                const newInput = document.createElement('input');
                newInput.type = 'hidden';
                newInput.name = `Tickets[${ticketIndex}].TicketId`;
                newInput.id = `TicketId_${ticketIndex}`;
                newInput.value = data.TicketId;

                ticketInputs.appendChild(newInput);

                // Here, you update the session expiry time
                document.getElementById('SessionExpiryTime').innerText = new Date(data.SessionExpiryTime).toLocaleString();

                ticketIndex++;
            });
    });

</script>

