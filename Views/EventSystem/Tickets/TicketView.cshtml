@model TicketPriceViewModel
@using Newtonsoft.Json
@using event_booking.Models.ViewModels;

@{
    var discountsJson = JsonConvert.SerializeObject(Model.Discounts);
}

<div class="container">
    <header>
        <h2>@Model.Event.Name</h2>
        <h3>Venue: @Model.Venue.Name</h3>
        <h4>Seat: @Model.Seat.SeatNumber</h4>
    </header>

    <div id="ticketsContainer">
        <div class="ticket">
            <form id="ticketForm" asp-action="ConfirmPurchase" method="post">
                <input type="hidden" asp-for="Ticket.TicketId" />

                <label for="FirstName">First Name:</label>
                <input type="text" id="FirstName" name="FirstName" placeholder="@ViewBag.FirstName" required />

                <label for="LastName">Last Name:</label>
                <input type="text" id="LastName" name="LastName" placeholder="@ViewBag.LastName" required />

                <label for="DiscountId">Discount:</label>
                <select id="DiscountId" name="Discount" onchange="recalculatePrice()">
                    @foreach (var discount in Model.DiscountNames)
                    {
                        <option value="@discount.Key">@discount.Value</option>
                    }
                </select>

                <label for="TicketPrice">Ticket Price:</label>
                <input type="text" id="TicketPriceDisplay" value="@Model.Ticket.TicketPrice" disabled />
                <input type="hidden" id="TicketPrice" name="TicketPrice" value="@Model.Ticket.TicketPrice" />

                <button type="submit" class="btn btn-primary">Purchase</button>
            </form>
        </div>
    </div>

    <button id="addTicketButton" class="btn btn-primary">Add another ticket</button>
</div>

@* Javascript for live price update functionality *@
<script type="text/javascript">
    function recalculatePrice() {
        // Get the selected discount
        var selectedDiscountId = $('#DiscountId').val();
        var discounts = @Html.Raw(discountsJson);

        // Get the discount multiplier from the selected discount
        var discountMultiplier = discounts[selectedDiscountId];

        // Get the base price (this should be passed from your server-side code)
        var basePrice = @Model.Ticket.BasePrice;

        // Calculate the new price
        var newPrice = basePrice * discountMultiplier;

        // Update the price in the form
        $('#TicketPriceDisplay').val(newPrice);
        $('#TicketPrice').val(newPrice);
    }

    // Call the function once when the page loads to set the initial price
    $(document).ready(function () {
        recalculatePrice();
    });
</script>

@* Add ticket javascript *@
<script type="text/javascript">
    $('#addTicketButton').click(function () {
        // Clone the first ticket form with its parent div
        var newForm = $('.ticket').first().clone();

        // Clear the form fields in the new form
        newForm.find('input[type="text"], select').val('');
        newForm.find('input[type="hidden"]').val('@Model.Ticket.TicketPrice');

        // Append the new form to the tickets container
        $('#ticketsContainer').append(newForm);
    });
</script>

